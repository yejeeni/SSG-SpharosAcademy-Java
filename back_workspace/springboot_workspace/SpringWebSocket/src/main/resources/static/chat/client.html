<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spring WebSocket ê¸°ë°˜ ì±„íŒ…</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        #app { max-width: 600px; margin: 20px auto; padding: 20px; font-family: Arial, sans-serif; }
        .chat-container { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; background: #fafafa; }
        .message { margin: 5px 0; padding: 8px; background: #fff; border-radius: 5px; border-left: 3px solid #007bff; }
        .system-message { border-left-color: #28a745; background: #f8f9fa; font-style: italic; }
        .user-list { border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f8f9fa; border-radius: 5px; }
        .user-item { padding: 3px 0; }
        input[type="text"] { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 3px; }
        button { padding: 8px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .disconnect-btn { background: #dc3545; }
        .disconnect-btn:hover { background: #c82333; }
    </style>
</head>
<body>
<div id="app">
    <div v-if="!connected">
        <h2>ì±„íŒ…ë°© ì…ì¥</h2>
        <input type="text" v-model="userName" placeholder="ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”" @keydown.enter="connect()">
        <button type="button" @click="connect()">ì›¹ì†Œì¼“ ì„œë²„ ì ‘ì†</button>
    </div>

    <div v-else>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <p><b>{{userName}}ë‹˜ ì ‘ì† ì¤‘</b></p>
            <button type="button" @click="disconnect()" class="disconnect-btn">ì ‘ì† ì¢…ë£Œ</button>
        </div>

        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
        <div class="chat-container" ref="chatContainer">
            <div v-for="msg in messages" :key="msg.id"
                 :class="['message', msg.sender === 'ì‹œìŠ¤í…œ' ? 'system-message' : '']">
                <strong>{{msg.sender}}:</strong> {{msg.content}}
                <small style="color: #666; float: right;">({{msg.timestamp}})</small>
            </div>
            <div v-if="messages.length === 0" style="color: #666; text-align: center; padding: 20px;">
                ì•„ì§ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <!-- ë©”ì‹œì§€ ì…ë ¥ -->
        <div style="display: flex; gap: 10px;">
            <input
                    type="text"
                    v-model="message"
                    @keydown.enter="sendMessage()"
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    style="flex: 1;">
            <button type="button" @click="sendMessage()">ì „ì†¡</button>
        </div>

        <!-- ì ‘ì†ì ëª©ë¡ -->
        <div class="user-list">
            <h3>ì´ ì ‘ì†ì ({{users.length}}ëª…)</h3>
            <div v-for="user in users" :key="user" class="user-item">
                ğŸŸ¢ {{user}}
            </div>
            <div v-if="users.length === 0" style="color: #666; font-style: italic;">
                ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

        <div>
            <input type="text" placeholder="ë°© ì´ë¦„ ì…ë ¥">
            <button type="button" @click="createRoom()">ë°© ìƒì„±</button>
        </div>
        <h3>ë°© ëª©ë¡</h3>
        <ul>
            <li v-for="room in rooms"></li>
        </ul>
    </div>
</div>

<script>
    const {createApp, ref, nextTick} = Vue;

    createApp({
        setup(){
            let socket = null;

            // ë°”ì¸ë”© ë³€ìˆ˜
            const connected = ref(false);
            const userName = ref("");
            const users = ref([]);
            const message = ref("");
            const messages = ref([]);
            const chatContainer = ref(null);
            const rooms = ref(null);

            /**
             * ì±„íŒ… ì»¨í…Œì´ë„ˆë¥¼ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
             */
            const scrollToBottom = () => {
                nextTick(() => {
                    if (chatContainer.value) {
                        chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
                    }
                });
            }

            /**
             * ë©”ì‹œì§€ë¥¼ messages ë°°ì—´ì— ì¶”ê°€
             */
            const addMessage = (sender, content, isSystem = false) => {
                messages.value.push({
                    id: Date.now() + Math.random(),
                    sender: isSystem ? "ì‹œìŠ¤í…œ" : sender,
                    content: content,
                    timestamp: new Date().toLocaleTimeString()
                });
                scrollToBottom();
            }

            /**
             * í˜ì´ë¡œë“œë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
             */
            const send = (payload) => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    console.log("ì „ì†¡:", payload);
                    socket.send(JSON.stringify(payload));
                }
            }

            /**
             * ì„œë²„ì™€ ì—°ê²°í•˜ëŠ” ë©”ì„œë“œ
             */
            const connect = () => {
                if (!userName.value.trim()) {
                    alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
                    return;
                }

                // ì„œë²„ì™€ ì›¹ì†Œì¼“ ì—°ê²° ì‹œë„
                socket = new WebSocket("ws://localhost:8888/ws");

                // ì—°ê²° ì„±ê³µ
                socket.onopen = () => {
                    connected.value = true;
                    console.log("ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ");

                    // ì„œë²„ì— ì ‘ì† ì•Œë¦¼
                    send({
                        type: "CONNECT",
                        sender: userName.value
                    });
                }

                // ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ
                socket.onmessage = (event) => {
                    console.log("ì„œë²„ê°€ ë³´ë‚¸ ë©”ì‹œì§€:", event.data);

                    try {
                        const json = JSON.parse(event.data);
                        console.log("íŒŒì‹±ëœ ë©”ì‹œì§€:", json);

                        // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
                        if (json.destination === "/users") {
                            users.value = json.body || [];
                            console.log("ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸:", users.value);
                        }
                        // ì±„íŒ… ë©”ì‹œì§€ ì²˜ë¦¬
                        else if (json.destination === "/messages") {
                            const messageData = json.body;
                            if (messageData.type === "SYSTEM") {
                                addMessage("", messageData.content, true);
                            } else {
                                addMessage(messageData.sender, messageData.content, false);
                            }
                        }
                    } catch (error) {
                        console.error("ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:", error);
                    }
                }

                /**
                 * ë°© ìƒì„±
                 */
                const createRoom=()=>{
                    if (roomName.value.trim()){
                        send({
                            type:"CREATE_ROOM",
                            sender:userName.value,
                            content:roomName.value
                        });
                    }
                }

                // ì—°ê²° ì¢…ë£Œ
                socket.onclose = (event) => {
                    console.log("ì›¹ì†Œì¼“ ì—°ê²° ì¢…ë£Œ:", event);
                    connected.value = false;
                    users.value = [];

                    if (event.code !== 1000) { // ì •ìƒ ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš°
                        addMessage("", "ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.", true);
                    }
                }

                // ì˜¤ë¥˜ ë°œìƒ
                socket.onerror = (error) => {
                    console.error("ì›¹ì†Œì¼“ ì˜¤ë¥˜:", error);
                    alert("ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }

            /**
             * ë©”ì‹œì§€ë¥¼ ì „ì†¡
             */
            const sendMessage = () => {
                if (message.value.trim()) {
                    send({
                        type: "MESSAGE",
                        sender: userName.value,
                        content: message.value
                    });
                    message.value = "";
                }
            }

            /**
             * ì„œë²„ì™€ ì—°ê²°ì„ í•´ì œí•˜ëŠ” ë©”ì„œë“œ
             */
            const disconnect = () => {
                if (socket && socket.readyState === WebSocket.OPEN) {
                    // ì„œë²„ì— í‡´ì¥ ì•Œë¦¼
                    send({
                        type: "DISCONNECT",
                        sender: userName.value
                    });

                    // ì¢…ë£Œ
                    setTimeout(() => {
                        if (socket) {
                            socket.close(1000, "ì‚¬ìš©ìê°€ ì ‘ì†ì„ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤");
                        }
                    }, 100);
                } else {
                    connected.value = false;
                    users.value = [];
                }
            }

            return {
                connected,
                userName,
                users,
                rooms,
                message,
                messages,
                chatContainer,
                connect,
                createRoom,
                sendMessage,
                disconnect
            }
        }
    }).mount("#app");
</script>
</body>
</html>