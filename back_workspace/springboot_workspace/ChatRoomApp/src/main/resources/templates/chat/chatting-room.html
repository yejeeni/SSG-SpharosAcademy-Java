<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„íŒ…ë°©</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/chatting-room.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
<div id="app">
    <div id="wrapper">
        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div id="content">
            <!-- í—¤ë” -->
            <div class="content-header">
                <h1 class="room-title">ğŸ® ê²Œì„ í† í¬ë°©</h1>
                <div class="room-info">
                    <span>ğŸ‘¥ {{participants?.length || 0}}ëª… ì°¸ì—¬ì¤‘</span>
                    <span>ğŸ• ì˜¤í›„ 2:30 ì‹œì‘</span>
                    <span>ğŸ“ ê³µê°œë°©</span>
                </div>
            </div>

            <!-- ì±„íŒ… ë¡œê·¸ -->
            <div class="content-body">
                <div class="chat-messages">
                    <!-- ë¡œê·¸ ì¶”ê°€ ê³µê°„-->
                </div>
            </div>
        </div>

        <!-- ì‚¬ì´ë“œë°” -->
        <div id="aside">
            <!-- ë‚´ ì •ë³´ -->
            <div class="aside-header">
                <div class="aside-header-content">
                    <div class="user-info">
                        <div class="user-avatar">ê¹€</div>
                        <div class="user-details">
                            <h3>ê¹€ì˜ˆì§„</h3>
                            <p>ë°©ì¥ â€¢ ì˜¨ë¼ì¸</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì°¸ì—¬ì ì •ë³´ -->
            <div class="aside-body">
                <h3 class="participants-title">
                    ğŸ‘¥ ì°¸ì—¬ì ({{participants?.length || 0}}ëª…)
                </h3>
                <div class="participant-list">
                    <div class="participant" v-for="user in participants">
                        <div class="participant-avatar">{{user.name.charAt(0)}}</div>
                        <div class="participant-info">
                            <div class="participant-name">{{user.name}}</div>
                            <div class="participant-status">{{user.id === masterId ? "ë°©ì¥" : "ì°¸ì—¬ì"}}</div>
                        </div>
                        <div class="online-indicator"></div>
                    </div>

                </div>
            </div>

            <!-- ë‚˜ê°€ê¸° ë²„íŠ¼ -->
            <div class="aside-footer">
                <button class="leave-btn">ğŸšª ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì±„íŒ… ì…ë ¥ -->
    <div id="footer">
        <div class="chat-input-container">
            <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." maxlength="500">
            <button class="send-btn" @click="sendMessage()">
                <svg viewBox="0 0 24 24">
                    <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const {createApp, ref, reactive, onMounted, onUnmounted} = Vue;
    createApp({
        setup() {
            // URLì—ì„œ UUID íŒŒë¼ë¯¸í„° ì¶”ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            const uuid = urlParams.get("uuid"); // ?uuid=... ì—ì„œ ì¶”ì¶œë¨
            let chatWs = null; // WebSocket ê°ì²´

            // ë°˜ì‘í˜• ë°ì´í„°
            const isConnected = ref(false);
            const messages = ref([]);
            let participants = ref([]);
            const masterId = ref("");

            // ìˆ˜ì‹ í•œ ë°© ì •ë³´ ì—…ë°ì´íŠ¸
            function updateRoomInfo(data){
                if (data.userList){
                    // ë°˜ì‘í˜• ë°ì´í„° ì—…ë°ì´íŠ¸
                    masterId.value = data.masterId;
                    participants.value = data.userList;
                }
            }

            // ìˆ˜ì‹ í•œ ì‚¬ìš©ì ë©”ì‹œì§€ ìƒì„±
            function createMessage(data){
                console.log("createSystemMessage");
                const messagesContainer = document.querySelector('.chat-messages');
                const messageDiv = document.createElement('div');

                if (data.type === "JOINED"){ // ì°¸ì—¬ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ì•¼í•˜ëŠ” ê²½ìš°
                    messageDiv.className = "system-message";
                    messageDiv.innerHTML = `<div class="system-text">${data.content}</div>`;
                } else if (data.type === "RECEIVED") { // ë°›ì€ ë©”ì‹œì§€ë¥¼ ìƒì„±í•´ì•¼í•˜ëŠ” ê²½ìš°
                    messageDiv.className = "message";
                    messageDiv.innerHTML = `
                    <div class="message-avatar">${data.sender.charAt(0)}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${data.sender}</span>
                            <span class="message-time">${data.timestamp}</span>
                        </div>
                        <div class="message-text">
                            ${data.content}
                        </div>
                    </div>
                    `;
                }
                messagesContainer.appendChild(messageDiv); // DOMì— ì‚½ì…
            }

            if (!uuid) {
                console.error("uuidê°€ ì—†ìŒ");
            }
            chatWs = new WebSocket(`ws://localhost:8888/chat/joinRoom/${uuid}`); // ì±„íŒ…ë°© ì›¹ì†Œì¼“

            // ì›¹ì†Œì¼“ ì„œë²„ ì—°ê²°
            const connect = () => {
                // ì—°ê²° ì„±ê³µ
                chatWs.onopen = (event) => {
                    console.log("WebSocket ì—°ê²° ì„±ê³µ", event);
                }

                // ë©”ì‹œì§€ ìˆ˜ì‹  (ëª¨ë“  ë©”ì‹œì§€ ì²˜ë¦¬)
                chatWs.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    console.log("ë©”ì‹œì§€ ìˆ˜ì‹ :", data);
                    // ë°©ì— ëŒ€í•œ ì •ë³´ì„± ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•œ ê²½ìš°
                    if (data.type === "ROOM_INFO"){
                        updateRoomInfo(data);
                    } else{ // ì‚¬ìš©ìë“¤ì— ëŒ€í•œ ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ í•œ ê²½ìš°
                        createMessage(data);
                    }
                }

                // ì—°ê²° ì—ëŸ¬
                chatWs.onerror = (error) => {
                    console.error("WebSocket ì—ëŸ¬:", error);
                }

                // ì—°ê²° ì¢…ë£Œ
                chatWs.onclose = (event) => {
                    console.log("WebSocket ì—°ê²° ì¢…ë£Œ:", event);
                }
            }

            // ë©”ì‹œì§€ ì „ì†¡
            function sendMessage() {
                const chatInput = document.querySelector('.chat-input'); // ì…ë ¥ì°½ì— ì‘ì„±í•œ ë©”ì‹œì§€
                const message = chatInput.value.trim(); // ê³µë°± ì œê±°
                if (message) {
                    console.log('ë©”ì‹œì§€ ì „ì†¡:', message);
                    chatInput.value = ''; // ì…ë ¥ì°½ ì •ë¦¬

                    chatWs.send(message); // ë©”ì‹œì§€ ì „ì†¡
                    addMessage(message, true);
                }
            }

            // ë°œì†¡í•œ ë©”ì‹œì§€ ìƒì„±
            function addMessage(text, isOwn = false) {
                const messagesContainer = document.querySelector('.chat-messages');
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'own' : ''}`;

                messageDiv.innerHTML = `
                        <div class="message-avatar">${isOwn ? 'ë‚˜' : 'ê¹€'}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${isOwn ? 'ë‚˜' : 'ê¹€ê²Œì´ë¨¸'}</span>
                                <span class="message-time">${timeString}</span>
                            </div>
                            <div class="message-text">${text}</div>
                        </div>
                    `;

                messagesContainer.appendChild(messageDiv);

                // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
                document.querySelector('.content-body').scrollTop =
                    document.querySelector('.content-body').scrollHeight;
            }

            onMounted(() => {
                // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²°
                connect();

                // í˜ì´ì§€ ë¡œë“œ í›„ì— DOM ìš”ì†Œ ì ‘ê·¼
                const chatInput = document.querySelector('.chat-input');
                const inputContainer = document.querySelector('.chat-input-container');

                if (chatInput && inputContainer) {
                    // ì…ë ¥ì°½ í¬ì»¤ìŠ¤ íš¨ê³¼
                    chatInput.addEventListener('focus', () => {
                        inputContainer.classList.add('focused');
                    });

                    chatInput.addEventListener('blur', () => {
                        inputContainer.classList.remove('focused');
                    });

                    // ì—”í„°í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                }

                // ì „ì†¡ ë²„íŠ¼ í´ë¦­
                const sendBtn = document.querySelector('.send-btn');
                if (sendBtn) {
                    sendBtn.addEventListener('click', sendMessage);
                }

                // ë‚˜ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                const leaveBtn = document.querySelector('.leave-btn');
                if (leaveBtn) {
                    leaveBtn.addEventListener('click', () => {
                        if (confirm('ì •ë§ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            window.location.href = '/chat/main';
                        }
                    });
                }
            });

            return {
                uuid,
                isConnected,
                messages,
                participants,
                masterId,
                sendMessage
            };
        }
    }).mount("#app");
</script>
</body>
</html>