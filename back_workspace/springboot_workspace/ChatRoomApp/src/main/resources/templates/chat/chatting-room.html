<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채팅방</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/chatting-room.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body>
<div id="app">
    <div id="wrapper">
        <!-- 메인 컨텐츠 -->
        <div id="content">
            <!-- 헤더 -->
            <div class="content-header">
                <h1 class="room-title">🎮 게임 토크방</h1>
                <div class="room-info">
                    <span>👥 {{participants?.length || 0}}명 참여중</span>
                    <span>🕐 오후 2:30 시작</span>
                    <span>📍 공개방</span>
                </div>
            </div>

            <!-- 채팅 로그 -->
            <div class="content-body">
                <div class="chat-messages">
                    <!-- 로그 추가 공간-->
                </div>
            </div>
        </div>

        <!-- 사이드바 -->
        <div id="aside">
            <!-- 내 정보 -->
            <div class="aside-header">
                <div class="aside-header-content">
                    <div class="user-info">
                        <div class="user-avatar">김</div>
                        <div class="user-details">
                            <h3>김예진</h3>
                            <p>방장 • 온라인</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 참여자 정보 -->
            <div class="aside-body">
                <h3 class="participants-title">
                    👥 참여자 ({{participants?.length || 0}}명)
                </h3>
                <div class="participant-list">
                    <div class="participant" v-for="user in participants">
                        <div class="participant-avatar">{{user.name.charAt(0)}}</div>
                        <div class="participant-info">
                            <div class="participant-name">{{user.name}}</div>
                            <div class="participant-status">{{user.id === masterId ? "방장" : "참여자"}}</div>
                        </div>
                        <div class="online-indicator"></div>
                    </div>

                </div>
            </div>

            <!-- 나가기 버튼 -->
            <div class="aside-footer">
                <button class="leave-btn">🚪 채팅방 나가기</button>
            </div>
        </div>
    </div>

    <!-- 채팅 입력 -->
    <div id="footer">
        <div class="chat-input-container">
            <input type="text" class="chat-input" placeholder="메시지를 입력하세요..." maxlength="500">
            <button class="send-btn" @click="sendMessage()">
                <svg viewBox="0 0 24 24">
                    <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script>
    const {createApp, ref, reactive, onMounted, onUnmounted} = Vue;
    createApp({
        setup() {
            // URL에서 UUID 파라미터 추출
            const urlParams = new URLSearchParams(window.location.search);
            const uuid = urlParams.get("uuid"); // ?uuid=... 에서 추출됨
            let chatWs = null; // WebSocket 객체

            // 반응형 데이터
            const isConnected = ref(false);
            const messages = ref([]);
            let participants = ref([]);
            const masterId = ref("");

            // 수신한 방 정보 업데이트
            function updateRoomInfo(data){
                if (data.userList){
                    // 반응형 데이터 업데이트
                    masterId.value = data.masterId;
                    participants.value = data.userList;
                }
            }

            // 수신한 사용자 메시지 생성
            function createMessage(data){
                console.log("createSystemMessage");
                const messagesContainer = document.querySelector('.chat-messages');
                const messageDiv = document.createElement('div');

                if (data.type === "JOINED"){ // 참여 메시지를 생성해야하는 경우
                    messageDiv.className = "system-message";
                    messageDiv.innerHTML = `<div class="system-text">${data.content}</div>`;
                } else if (data.type === "RECEIVED") { // 받은 메시지를 생성해야하는 경우
                    messageDiv.className = "message";
                    messageDiv.innerHTML = `
                    <div class="message-avatar">${data.sender.charAt(0)}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">${data.sender}</span>
                            <span class="message-time">${data.timestamp}</span>
                        </div>
                        <div class="message-text">
                            ${data.content}
                        </div>
                    </div>
                    `;
                }
                messagesContainer.appendChild(messageDiv); // DOM에 삽입
            }

            if (!uuid) {
                console.error("uuid가 없음");
            }
            chatWs = new WebSocket(`ws://localhost:8888/chat/joinRoom/${uuid}`); // 채팅방 웹소켓

            // 웹소켓 서버 연결
            const connect = () => {
                // 연결 성공
                chatWs.onopen = (event) => {
                    console.log("WebSocket 연결 성공", event);
                }

                // 메시지 수신 (모든 메시지 처리)
                chatWs.onmessage = (e) => {
                    const data = JSON.parse(e.data);
                    console.log("메시지 수신:", data);
                    // 방에 대한 정보성 메시지를 수신한 경우
                    if (data.type === "ROOM_INFO"){
                        updateRoomInfo(data);
                    } else{ // 사용자들에 대한 메시지를 수신한 경우
                        createMessage(data);
                    }
                }

                // 연결 에러
                chatWs.onerror = (error) => {
                    console.error("WebSocket 에러:", error);
                }

                // 연결 종료
                chatWs.onclose = (event) => {
                    console.log("WebSocket 연결 종료:", event);
                }
            }

            // 메시지 전송
            function sendMessage() {
                const chatInput = document.querySelector('.chat-input'); // 입력창에 작성한 메시지
                const message = chatInput.value.trim(); // 공백 제거
                if (message) {
                    console.log('메시지 전송:', message);
                    chatInput.value = ''; // 입력창 정리

                    chatWs.send(message); // 메시지 전송
                    addMessage(message, true);
                }
            }

            // 발송한 메시지 생성
            function addMessage(text, isOwn = false) {
                const messagesContainer = document.querySelector('.chat-messages');
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${isOwn ? 'own' : ''}`;

                messageDiv.innerHTML = `
                        <div class="message-avatar">${isOwn ? '나' : '김'}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-sender">${isOwn ? '나' : '김게이머'}</span>
                                <span class="message-time">${timeString}</span>
                            </div>
                            <div class="message-text">${text}</div>
                        </div>
                    `;

                messagesContainer.appendChild(messageDiv);

                // 스크롤을 맨 아래로
                document.querySelector('.content-body').scrollTop =
                    document.querySelector('.content-body').scrollHeight;
            }

            onMounted(() => {
                // 페이지 로드 시 자동 연결
                connect();

                // 페이지 로드 후에 DOM 요소 접근
                const chatInput = document.querySelector('.chat-input');
                const inputContainer = document.querySelector('.chat-input-container');

                if (chatInput && inputContainer) {
                    // 입력창 포커스 효과
                    chatInput.addEventListener('focus', () => {
                        inputContainer.classList.add('focused');
                    });

                    chatInput.addEventListener('blur', () => {
                        inputContainer.classList.remove('focused');
                    });

                    // 엔터키로 메시지 전송
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });
                }

                // 전송 버튼 클릭
                const sendBtn = document.querySelector('.send-btn');
                if (sendBtn) {
                    sendBtn.addEventListener('click', sendMessage);
                }

                // 나가기 버튼 이벤트
                const leaveBtn = document.querySelector('.leave-btn');
                if (leaveBtn) {
                    leaveBtn.addEventListener('click', () => {
                        if (confirm('정말 채팅방을 나가시겠습니까?')) {
                            window.location.href = '/chat/main';
                        }
                    });
                }
            });

            return {
                uuid,
                isConnected,
                messages,
                participants,
                masterId,
                sendMessage
            };
        }
    }).mount("#app");
</script>
</body>
</html>