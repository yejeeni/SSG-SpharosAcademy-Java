<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Streaming Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/chat-main.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
<div id="app">
    <div id="wrapper">
        <div id="aside">
            <div class="aside-header">
                <h2>ğŸ¥ Live Stream</h2>
                <p>ì‹¤ì‹œê°„ ë°©ì†¡ í”Œë«í¼</p>
            </div>

            <div class="room-creator" th:if="${session.member} != null">
                <h3 th:text="|${session.member.name}ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!|">ì´ë¦„ë‹˜ ì•ˆë…•í•˜ì„¸ìš”!</h3>
                <h3>ë°©ì†¡ì„ ì‹œì‘í• ê¹Œìš”?</h3>
                <div class="input-group">
                    <label for="roomTitle">ë°©ì†¡ ì œëª©</label>
                    <input type="text" id="roomTitle" v-model="roomTitle" placeholder="ë°©ì†¡ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”...">
                </div>
                <!--            <div class="input-group">-->
                <!--                <label for="roomCategory">ì¹´í…Œê³ ë¦¬</label>-->
                <!--                <input type="text" id="roomCategory" placeholder="ê²Œì„, í† í¬, ìŒì•… ë“±...">-->
                <!--            </div>-->
                <button class="create-btn" @click="createRoom()">ë°©ì†¡ ì‹œì‘</button>
                <ul>
                    <li>í˜„ì¬ ì ‘ì†ì</li>
                    <li v-for="member in memberList">{{member.name}}</li>
                </ul>
            </div>

            <div class="stats">
                <div class="stats-item">
                    <div class="stats-number">1,247</div>
                    <div class="stats-label">í™œì„± ë°©ì†¡</div>
                </div>
                <div class="stats-item">
                    <div class="stats-number">15,892</div>
                    <div class="stats-label">ì´ ì‹œì²­ì</div>
                </div>
            </div>
        </div>

        <div id="content">
            <div class="content-header">
                <h1>ì‹¤ì‹œê°„ ë°©ì†¡</h1>
                <!--            <div class="filter-tabs">-->
                <!--                <div class="filter-tab active">ì „ì²´</div>-->
                <!--                <div class="filter-tab">ê²Œì„</div>-->
                <!--                <div class="filter-tab">í† í¬</div>-->
                <!--                <div class="filter-tab">ìŒì•…</div>-->
                <!--            </div>-->
            </div>

            <div class="rooms-grid">
                <div class="room" v-for="room in roomList" :key="room.uuid" @click="joinRoom(room.uuid)">
                    <div class="room-header">
                        <div class="room-header-content">
                            <div class="room-title">{{room.roomName}}</div>
                            <div class="room-meta">
                                <div class="live-indicator">LIVE</div>
                                <div class="viewer-count">1,234ëª… ì‹œì²­ì¤‘</div>
                            </div>
                        </div>
                    </div>
                    <div class="room-body">
                        <div class="video-placeholder">ğŸ®</div>
                    </div>
                    <div class="room-footer">
                        <div class="streamer-info">
                            <div class="streamer-avatar">ê¹€</div>
                            <div class="streamer-details">
                                <h4>{{room.masterId}}</h4>
                                <p>ê²Œì„ â€¢ 2ì‹œê°„ ì „ ì‹œì‘</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const {createApp, reactive, ref, onMounted} = Vue;
    createApp({
        setup(){
            const userId = '[[${session.member.id}]]';
            let ws = null;

            let memberList = reactive([]);
            let roomList = reactive([]);
            const roomTitle = ref('');

            // ë°© ë“¤ì–´ê°€ê¸°
            const joinRoom = (uuid) => {
                console.log("í´ë¦­ëœ ë°© UUID:", uuid);
                ws.close(); // ë©”ì¸ ì—°ê²° ì¢…ë£Œ
                window.location.href = "/chat/joinRoom?uuid="+uuid;
            }

            // ì„œë²„ì— ë©”ì‹œì§€ ì „ì†¡
            const request = (data) => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(data);
                } else {
                    console.error("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
            }

            // ì›¹ì†Œì¼“ ì„œë²„ ì—°ê²°
            const connect = () => {
                ws = new WebSocket("ws://localhost:8888/chat/multi");

                // ì—°ê²° ì„±ê³µ
                ws.onopen = (event) => {
                    console.log("WebSocket ì—°ê²° ì„±ê³µ!", event);
                }

                // ë©”ì‹œì§€ ìˆ˜ì‹  (ëª¨ë“  ë©”ì‹œì§€ ì²˜ë¦¬)
                ws.onmessage = (e) => {
                    console.log("ë©”ì‹œì§€ ìˆ˜ì‹ :", e.data);

                    try {
                        const responseJson = JSON.parse(e.data);
                        console.log("ì‘ë‹µ íƒ€ì…:", responseJson.responseType);

                        // ì—°ê²° ì‹œ ë˜ëŠ” ë°© ìƒì„± ì‹œ ëª¨ë‘ ì²˜ë¦¬
                        if (responseJson.responseType === "createRoom" ||
                            responseJson.responseType === "userConnected") {

                            // ì ‘ì†ì ëª…ë‹¨ ì—…ë°ì´íŠ¸
                            if (responseJson.memberList) {
                                memberList.splice(0); // ê¸°ì¡´ ë°°ì—´ ì‚­ì œ
                                responseJson.memberList.forEach(member => {
                                    memberList.push(member);
                                });
                                console.log("ì ‘ì†ì ì—…ë°ì´íŠ¸:", memberList.length, "ëª…");
                            }

                            // ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
                            if (responseJson.roomList) {
                                roomList.splice(0); // ê¸°ì¡´ ë°°ì—´ ì‚­ì œ
                                responseJson.roomList.forEach(room => {
                                    roomList.push(room);
                                });
                                console.log("ë°© ëª©ë¡ ì—…ë°ì´íŠ¸:", roomList.length, "ê°œ");
                            }

                            // ë°© ìƒì„±í•œ ê²½ìš°ì—ë§Œ í˜ì´ì§€ ì´ë™
                            if (responseJson.responseType === "createRoom") {
                                console.log("ë°© ìƒì„± ì™„ë£Œ, í˜ì´ì§€ ì´ë™");
                                joinRoom();
                            }
                        }
                    } catch (error) {
                        console.error("JSON íŒŒì‹± ì—ëŸ¬:", error);
                    }
                }

                // ì—°ê²° ì¢…ë£Œ
                ws.onclose = (event) => {
                    console.log("WebSocket ì—°ê²° ì¢…ë£Œ:", event);
                }

                // ì—ëŸ¬ ë°œìƒ
                ws.onerror = (error) => {
                    console.error("WebSocket ì—ëŸ¬:", error);
                }
            }

            // ë°© ìƒì„± ìš”ì²­
            const createRoom = () => {
                if (!roomTitle.value.trim()) {
                    alert("ë°©ì†¡ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                    return;
                }

                const payload = {
                    requestType: "createRoom",
                    userId: userId,
                    roomName: roomTitle.value,
                }

                console.log("ë°© ìƒì„± ìš”ì²­:", payload);
                request(JSON.stringify(payload));
                roomTitle.value = ''; // ì…ë ¥ì°½ ì´ˆê¸°í™”
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²°
            onMounted(() => {
                connect();
            });

            return {memberList, roomList, roomTitle, createRoom, joinRoom, connect};
        }
    }).mount("#app");
</script>


</body>

</html>